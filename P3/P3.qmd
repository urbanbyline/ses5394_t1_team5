---
title: "P3: Trip Generation"
format: 
  html:
    theme: minty
    toc: true
    toc-location: left
editor: visual
---

## Load libraries

This analysis uses the following packages:

```{r, warning=FALSE, message=FALSE}

library(tidyverse)
library(here)
library(knitr)
library(srvyr)
library(mlogit)
library(caret)
library(pscl)
library(dplyr)
library(readr)
library(MASS)


here("code",
     "mlogit_helpers.R") |>
  source()
```

## Load datasets

This analysis uses household-level, person-level, and trip-level data from the 2017 National Household Travel Survey. Keep in mind that TDM23 is meant to represent travel on a "typical weekday", so for comparison purposes, we'll filter our data to only include participants who completed their travel diary on a weekday.

```{r}
hh_data <- here("data",
                "NHTS",
                "hhpub.csv") |>
  read_csv(show_col_types = FALSE)

person_data <- here("data",
                    "NHTS",
                    "perpub.csv") |>
  read_csv(show_col_types = FALSE)

trip_data <- here("data",
                    "NHTS",
                    "trippub.csv") |>
  read_csv(show_col_types = FALSE)

str(trip_data)


trip_data <- dplyr::select(trip_data,
  HOUSEID,
  PERSONID,
  TDTRPNUM,
  TRIPPURP,
  WHYFROM,
  WHYTO,
  TRPTRANS, 
  R_AGE,
  EDUC,
  TRPACCMP,
  PSGR_FLG,
  R_SEX,
  TRAVDAY,
  WTTRDFIN)

head(trip_data, 20)

chaffeured_trips <- trip_data %>%
  mutate(UNIQUEID = paste(HOUSEID, PERSONID, sep = "_"))

chaffeured_trips <- trip_data %>%
  filter(WHYFROM == "06" | WHYTO == "06") %>%
  group_by(HOUSEID, PERSONID)


chaffeured_trips |>
  filter(HOUSEID == "40794301" & PERSONID == "02") |>
  kable()

```

Defining the following columns for clarity:

TDTRPNUM - Number of trips in a day starting with one for each person in the file

TRIPPUP - Generalized Purpose of Trip - Home Based and Non-Home Based. Categories are the following: HBO (home-based trip other), HBSHOP (home-based trip shopping), HBSOCREC (home based trip (social/recreational), HBW (home based trip work), NHB (not a home based trip)

WHYFROM - Trip Origin Purpose such as Regular home activities, work, child care, etc

WHYTO - Trip Destination Purpose such as work child care etc

TRPTRANS - Trip Mode Derived such as walking, car

R_AGE - Respondent age

EDUC - Educational Attainment

WTTRDFIN - final trip weight

###### [Other Relevant columns to consider:]{.underline}

[PSGR_FLG - Respondent was passenger on trip - so our definition could be people as drivers vs people was passengers? Where 01 is Yes they were the passenger and 02 is no they were the driver]{.underline}

[TRPACCMP - Count of People on Trip - so our definition could be driving by yourself or carpooling]{.underline}

My New Definition: Dropping off picking up. 06 in WHYTO and WHYFROM

## Building Predictive Model

With the predictor variables:

-   PERSON LEVEL gender -

-   PERSON LEVEL age -

-   PERSON LEVEL worker status -

-   HOUSEHOLD LEVEL vehicle availability -

-   HOUSEHOLD LEVEL household income -

-   HOUSEHOLD LEVEL household size - done

-   HOUSEHOLD LEVEL young Child

-   HOUSEHOLD LEVEL - NUMBER OF WORKERS

-   HOUSEHOLD LEVEL -number of seniors

-   TRIP LEVEL - TRAVEL DAY

```{r}
hh_data <- hh_data |>
  select(WRKCOUNT,
         DRVRCNT,
         HHVEHCNT,
         HHSIZE,
         NUMADLT,
         HHFAMINC,
         HOUSEID)
hh_data <- hh_data |>
  mutate(veh_avail = case_when(HHVEHCNT == 0 ~ "Zero",
                               DRVRCNT > HHVEHCNT ~ "Insuff.",
                               TRUE ~ "Suff."))
hh_data <- hh_data |>
  mutate(n_child = HHSIZE - NUMADLT)

n_seniors <- person_data |>
  mutate(is_senior = R_AGE > 64) |>
  group_by(HOUSEID) |>
  summarise(n_seniors = sum(is_senior))

hh_data <- hh_data |>
  left_join(n_seniors)

hh_data <- hh_data |>
  mutate(three_drivers = DRVRCNT > 2)

hh_data <- hh_data |>
  mutate(n_extra_drivers = ifelse(three_drivers, DRVRCNT - 2, 0))

hh_data <- hh_data |>
  mutate(HHFAMINC = as.numeric(HHFAMINC)) |>
  filter(HHFAMINC > 0) |>
  mutate(income = case_when(HHFAMINC < 4 ~ "low",
                             HHFAMINC < 5 & HHSIZE > 1 ~ "low",
                             HHFAMINC < 6 & HHSIZE > 3 ~ "low",
                             HHFAMINC < 7 & HHSIZE > 5 ~ "low",
                             HHFAMINC < 8 & HHSIZE > 7 ~ "low",
                             HHFAMINC > 8 ~ "high",
                            TRUE ~ "medium")) |>
    mutate(income = factor(income, levels = c("medium", "low", "high")))

non_work_driver <- person_data |>
  mutate(non_work_driver = WORKER == "02" & DRIVER == "01") |>
  group_by(HOUSEID) |>
  summarise(non_work_driver = max(non_work_driver))

hh_data <- hh_data |>
  left_join(non_work_driver)

hh_data <- hh_data |>
  select(HOUSEID,
         veh_avail,
         WRKCOUNT,
         n_child,
         n_seniors,
         n_extra_drivers,
         three_drivers,
         non_work_driver,
         income)

workers <- person_data |>
  filter(WORKER == "01") |>
  select(HOUSEID, PERSONID, R_SEX, WKFTPT, R_RACE, R_AGE) |>
  mutate(WKFTPT = as.numeric(WKFTPT)) |>
  filter(WKFTPT > 0) |>
  mutate(female = R_SEX == "02") |>
  mutate(part_time = WKFTPT == 2) |>
  inner_join(hh_data)


chaffeured_trips_count <- chaffeured_trips |>
  group_by(HOUSEID, PERSONID) |>
  summarise(chaffeured_trips = n())

workers <- workers |>
  left_join(chaffeured_trips_count) |>
  replace_na(list(chaffeured_trips = 0)) |>
  mutate(income = factor(income, levels = c("low", "middle", "high")))
```

### Data Visualizations and Regression

```{r}
ggplot(workers) +
  geom_histogram(aes(x = chaffeured_trips),
                 binwidth = 1,
                 color = "gray",
                 fill = "lightgreen") +
  scale_x_continuous(name = "Number of chaffeured trips",
                     breaks = seq(0, 12, by=1)) +
  scale_y_continuous(name = "Number of workers in sample") +
  theme_minimal()


workers |>
  summarise(`Average count of chaffeured_trips trips` = mean(chaffeured_trips),
            `Standard deviation` = sd(chaffeured_trips)) |>
  kable(digits = 3)

model_nb <- glm.nb(chaffeured_trips ~ n_seniors + 
                     WRKCOUNT + 
                     veh_avail + 
                     income + 
                     female + 
                     part_time,  data = workers)
summary(model_nb)


zero_inflated_chaffeured <- zeroinfl(chaffeured_trips ~ 
                          n_seniors + 
                          R_AGE +
                          WRKCOUNT +                          
                          veh_avail +                          
                          income +                          
                          female +                          
                          part_time |                         
                          n_seniors + 
                          R_AGE +
                          WRKCOUNT +                          
                          veh_avail +                          
                          income +                          
                          female +                          
                          part_time,     
                        data = workers,    
                        dist = "poisson")

summary(zero_inflated_chaffeured)

AIC(zero_inflated_chaffeured)

```
